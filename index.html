<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Converter & Merger</title>
    
    <!-- ==========================================
         „É©„Ç§„Éñ„É©„É™Ë™≠„ÅøËæº„Åø
    =========================================== -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>

    <style>
        /* ==========================================
           CSSÂ§âÊï∞ („ÉÄ„Éº„ÇØ„É¢„Éº„Éâ„Éá„Éï„Ç©„É´„Éà)
        =========================================== */
        :root {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
            --border-color: #333333;
            --input-bg: #2c2c2c;
            --input-border: #444;
            --primary-color: #4a90e2;
            --primary-hover: #357abd;
            --danger-color: #cf6679;
            --btn-text: #ffffff;
            --scroll-track: #1e1e1e;
            --scroll-thumb: #555;
            --remove-btn-color: #888;
            --remove-btn-hover: #fff;
        }

        /* „É©„Ç§„Éà„É¢„Éº„Éâ */
        body.light-mode {
            --bg-color: #f0f2f5;
            --container-bg: #ffffff;
            --text-main: #333333;
            --text-sub: #666666;
            --border-color: #cccccc;
            --input-bg: #ffffff;
            --input-border: #bbbbbb;
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --danger-color: #dc3545;
            --btn-text: #ffffff;
            --scroll-track: #f1f1f1;
            --scroll-thumb: #888;
            --remove-btn-color: #999;
            --remove-btn-hover: #333;
        }

        /* ==========================================
           „Éô„Éº„Çπ„Çπ„Çø„Ç§„É´
        =========================================== */
        body {
            font-family: sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--container-bg);
            padding: 25px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            position: relative;
        }

        #theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }
        #theme-toggle:hover { background: var(--input-bg); }

        h1 {
            text-align: center;
            font-size: 20px;
            margin: 0 0 25px 0;
            font-weight: normal;
        }

        .section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .section:last-child { border: none; padding-bottom: 0; margin-bottom: 0; }

        .row { display: flex; gap: 20px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 240px; }

        label {
            display: block;
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 6px;
            color: var(--text-sub);
        }

        input[type="text"], select, input[type="number"] {
            width: 100%;
            padding: 8px;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-main);
            border-radius: 3px;
            box-sizing: border-box;
        }
        input[type="text"]:focus, select:focus, input[type="number"]:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .range-wrap { display: flex; align-items: center; gap: 10px; }
        input[type="range"] { flex: 1; cursor: pointer; accent-color: var(--primary-color); }
        .dpi-input { width: 70px !important; text-align: right; }

        .option-group { margin-top: 5px; }
        .option-label {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
            font-size: 14px;
            cursor: pointer;
        }
        .option-label input { margin-right: 5px; accent-color: var(--primary-color); }

        #drop-zone {
            border: 2px dashed var(--border-color);
            padding: 30px;
            text-align: center;
            background: rgba(128, 128, 128, 0.05);
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 15px;
            transition: background 0.2s;
        }
        #drop-zone:hover {
            background: rgba(128, 128, 128, 0.1);
            border-color: var(--primary-color);
        }
        #drop-zone p { margin: 0; font-size: 14px; }

        #file-list-container {
            display: none;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            background: var(--input-bg);
        }
        #file-list {
            padding: 0;
            margin: 0;
            list-style: none;
            max-height: 200px;
            overflow-y: auto;
        }
        #file-list::-webkit-scrollbar { width: 8px; }
        #file-list::-webkit-scrollbar-track { background: var(--scroll-track); }
        #file-list::-webkit-scrollbar-thumb { background: var(--scroll-thumb); border-radius: 4px; }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 10px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
            cursor: grab;
        }
        .file-item:last-child { border-bottom: none; }
        .file-item:hover { background: rgba(255, 255, 255, 0.05); }

        .badge {
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 10px;
            color: #fff;
            margin-right: 8px;
            font-weight: bold;
        }
        .badge-pdf { background: #d32f2f; }
        .badge-img { background: #1976d2; }

        /* ÂâäÈô§„Éú„Çø„É≥ */
        .remove-btn {
            background: transparent;
            color: var(--remove-btn-color);
            border: none;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px; 
            margin-left: 10px;
            padding: 0;
            line-height: 1;
            transition: color 0.2s;
        }
        .remove-btn:hover { color: var(--remove-btn-hover); }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button {
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            color: var(--btn-text);
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        #run-btn { background: var(--primary-color); flex: 2; font-weight: bold; }
        #run-btn:disabled { background: var(--border-color); cursor: not-allowed; opacity: 0.6; }
        #stop-btn { background: var(--danger-color); display: none; flex: 2; }
        #reset-btn { background: #6c757d; flex: 1; max-width: 100px; }

        #progress-area { margin-top: 15px; display: none; }
        #progress-text { font-size: 12px; margin-bottom: 5px; text-align: left; }
        .progress-track {
            background: var(--border-color);
            height: 4px;
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
        }

        #log-area {
            margin-top: 15px;
            max-height: 150px;
            overflow-y: auto;
            background: #000000;
            color: #ccc;
            padding: 10px;
            font-size: 12px;
            font-family: monospace;
            border: 1px solid var(--border-color);
        }
        body.light-mode #log-area { background: #f9f9f9; color: #333; }
        .log { margin-bottom: 2px; }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .processing { color: #2196f3; }
    </style>
</head>
<body>

<div class="container">
    <button id="theme-toggle" onclick="toggleTheme()">‚òÄ Light Mode</button>
    <h1>PDFÁîªÂÉèÂåñÔºûÂÜçÁµêÂêà ÔºÜ ÁîªÂÉèPDFÁµêÂêà„ÉÑ„Éº„É´</h1>

    <!-- Ë®≠ÂÆö -->
    <div class="section">
        <div class="row">
            <div class="col">
                <label>Â§âÊèõÂΩ¢Âºè</label>
                <select id="format" onchange="toggleJpeg()">
                    <option value="png">PNG (È´òÁîªË≥™)</option>
                    <option value="jpeg" selected>JPEG (ËªΩÈáè)</option>
                </select>

                <div id="jpeg-box" style="display:block; margin-top:10px;">
                    <label>ÂìÅË≥™ (0.1 - 1.0)</label>
                    <div class="range-wrap">
                        <input type="range" id="quality" min="0.1" max="1.0" step="0.1" value="1.0" oninput="document.getElementById('q-val').textContent=this.value">
                        <span id="q-val" style="width:30px; text-align:right;">1.0</span>
                    </div>
                </div>
            </div>
            <div class="col">
                <label>Ëß£ÂÉèÂ∫¶ (DPI)</label>
                <div class="range-wrap">
                    <input type="range" id="dpi-slider" min="72" max="600" step="10" value="120">
                    <input type="number" id="dpi-number" value="120" min="1" step="10" class="dpi-input">
                </div>
            </div>
        </div>
    </div>

    <!-- ‰øùÂ≠ò„Ç™„Éó„Ç∑„Éß„É≥ -->
    <div class="section">
        <div class="row">
            <div class="col">
                <label>‰øùÂ≠ò„Ç™„Éó„Ç∑„Éß„É≥</label>
                <div class="option-group">
                    <label class="option-label">
                        <input type="checkbox" id="zip-check"> ÂÆå‰∫ÜÂæå„Å´ZIP„Å´„Åæ„Å®„ÇÅ„Çã
                    </label>
                </div>
            </div>
            <div class="col">
                <label>‰øùÂ≠òÂÖà</label>
                <div class="option-group">
                    <label class="option-label">
                        <input type="radio" name="save-loc" value="download" checked> „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ (Ê®ôÊ∫ñ)
                    </label>
                    <label class="option-label" title="ÂØæÂøú„Éñ„É©„Ç¶„Ç∂„ÅÆ„Åø">
                        <input type="radio" name="save-loc" value="folder"> „Éï„Ç©„É´„ÉÄÈÅ∏Êäû
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- ÁΩÆÊèõ -->
    <div class="section">
        <label>„Éï„Ç°„Ç§„É´ÂêçÁΩÆÊèõ (PDF„ÅÆ„Åø)</label>
        <div class="row">
            <div class="col"><input type="text" id="find-txt" placeholder="Ê§úÁ¥¢ÊñáÂ≠óÂàó"></div>
            <div class="col"><input type="text" id="replace-txt" placeholder="ÁΩÆÊèõÊñáÂ≠óÂàó"></div>
        </div>
    </div>

    <!-- „Éï„Ç°„Ç§„É´„Ç®„É™„Ç¢ -->
    <div class="section">
        <div id="drop-zone" onclick="document.getElementById('file-input').click()">
            <p>PDF / ÁîªÂÉè„Éï„Ç°„Ç§„É´„Çí„Éâ„É≠„ÉÉ„Éó („ÇØ„É™„ÉÉ„ÇØ„ÅßÈÅ∏Êäû)</p>
            <input type="file" id="file-input" multiple accept="application/pdf, image/*" style="display:none">
        </div>
        <div id="file-list-container">
            <ul id="file-list"></ul>
        </div>
    </div>

    <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ -->
    <div class="btn-group">
        <button id="run-btn" onclick="start()" disabled>Â§âÊèõÈñãÂßã</button>
        <button id="stop-btn" onclick="cancel()">‰∏≠Ê≠¢</button>
        <button id="reset-btn" onclick="resetAll()">„É™„Çª„ÉÉ„Éà</button>
    </div>

    <!-- ÈÄ≤Êçó„Éª„É≠„Ç∞ -->
    <div id="progress-area">
        <div id="progress-text">ÂæÖÊ©ü‰∏≠</div>
        <div class="progress-track"><div class="progress-bar" id="progress-bar"></div></div>
    </div>
    <div id="log-area"></div>
</div>

<script>
    // --- „ÉÜ„Éº„ÉûÂàá„ÇäÊõø„Åà ---
    function toggleTheme() {
        const body = document.body;
        const btn = document.getElementById('theme-toggle');
        body.classList.toggle('light-mode');
        if (body.classList.contains('light-mode')) {
            btn.textContent = 'üåô Dark Mode';
        } else {
            btn.textContent = '‚òÄ Light Mode';
        }
    }

    // --- „É©„Ç§„Éñ„É©„É™Ë®≠ÂÆö ---
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    const CMAP_URL = 'https://unpkg.com/pdf.js-dist@3.11.174/cmaps/';
    
    let fileQueue = [];
    let isProcessing = false;
    let abortCtrl = false;
    let sortable; 

    const dpiSlider = document.getElementById('dpi-slider');
    const dpiNumber = document.getElementById('dpi-number');
    dpiSlider.addEventListener('input', function() { dpiNumber.value = this.value; });
    dpiNumber.addEventListener('input', function() { dpiSlider.value = this.value; });

    function toggleJpeg() {
        document.getElementById('jpeg-box').style.display = document.getElementById('format').value === 'jpeg' ? 'block' : 'none';
    }

    function resetAll() {
        if (isProcessing) return alert("Âá¶ÁêÜ‰∏≠„ÅØ„É™„Çª„ÉÉ„Éà„Åß„Åç„Åæ„Åõ„Çì");
        fileQueue = [];
        document.getElementById('file-input').value = '';
        document.getElementById('log-area').innerHTML = '';
        document.getElementById('progress-area').style.display = 'none';
        document.getElementById('find-txt').value = '';
        document.getElementById('replace-txt').value = '';
        updateList();
    }

    const handleFiles = (files) => {
        if (isProcessing) return;
        Array.from(files).forEach(f => {
            if (f.type === 'application/pdf' || f.type.startsWith('image/')) {
                fileQueue.push(f);
            }
        });
        updateList();
    };

    function updateList() {
        const listEl = document.getElementById('file-list');
        const runBtn = document.getElementById('run-btn');
        listEl.innerHTML = '';
        if (fileQueue.length > 0) {
            document.getElementById('file-list-container').style.display = 'block';
            runBtn.disabled = isProcessing;
            runBtn.textContent = `Â§âÊèõÈñãÂßã (${fileQueue.length} „Éï„Ç°„Ç§„É´)`;
            fileQueue.forEach((file, index) => {
                const item = document.createElement('li');
                item.className = 'file-item';
                item.dataset.index = index;
                const typeBadge = file.type === 'application/pdf'
                    ? '<span class="badge badge-pdf">PDF</span>'
                    : '<span class="badge badge-img">IMG</span>';
                
                item.innerHTML = `<span>${typeBadge}${file.name}</span><button class="remove-btn" onclick="removeFile(${index})" title="ÂâäÈô§">√ó</button>`;
                listEl.appendChild(item);
            });
            if (sortable) sortable.destroy();
            sortable = new Sortable(listEl, {
                draggable: '.file-item',
                onUpdate: (evt) => {
                    const movedFile = fileQueue.splice(evt.oldIndex, 1)[0];
                    fileQueue.splice(evt.newIndex, 0, movedFile);
                },
                handle: '.file-item',
                cursor: 'grab',
                animation: 150
            });
        } else {
            document.getElementById('file-list-container').style.display = 'none';
            runBtn.disabled = true;
            runBtn.textContent = 'Â§âÊèõÈñãÂßã';
            if (sortable) { sortable.destroy(); sortable = null; }
        }
    }

    function removeFile(index) {
        if (isProcessing) return;
        fileQueue.splice(index, 1);
        updateList();
    }

    const dropZone = document.getElementById('drop-zone');
    dropZone.ondragover = e => { e.preventDefault(); dropZone.style.borderColor = 'var(--primary-color)'; };
    dropZone.ondragleave = () => { dropZone.style.borderColor = 'var(--border-color)'; };
    dropZone.ondrop = e => { 
        e.preventDefault(); 
        dropZone.style.borderColor = 'var(--border-color)'; 
        handleFiles(e.dataTransfer.files); 
    };
    document.getElementById('file-input').onchange = e => handleFiles(e.target.files);
    document.getElementById('file-input').onclick = e => e.target.value = '';

    function cancel() {
        if (isProcessing) {
            abortCtrl = true;
            document.getElementById('stop-btn').textContent = "ÂÅúÊ≠¢‰∏≠...";
        }
    }

    function getTimestampFilename() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        const H = String(now.getHours()).padStart(2, '0');
        const M = String(now.getMinutes()).padStart(2, '0');
        const S = String(now.getSeconds()).padStart(2, '0');
        return `${y}${m}${d}${H}${M}${S}.pdf`;
    }

    // --- „É°„Ç§„É≥Âá¶ÁêÜ ---
    async function start() {
        if (fileQueue.length === 0) return;
        
        const useZip = document.getElementById('zip-check').checked;
        const saveLoc = document.querySelector('input[name="save-loc"]:checked').value;
        let dirHandle = null;

        if (saveLoc === 'folder') {
            if (!('showDirectoryPicker' in window)) {
                alert("„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ„Éï„Ç©„É´„ÉÄÈÅ∏Êäû„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÊ®ôÊ∫ñ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ");
            } else {
                try {
                    dirHandle = await window.showDirectoryPicker({ mode: "readwrite" });
                } catch (err) { return; }
            }
        }

        isProcessing = true;
        abortCtrl = false;
        
        document.getElementById('run-btn').disabled = true;
        document.getElementById('run-btn').textContent = "Âá¶ÁêÜ‰∏≠...";
        document.getElementById('stop-btn').style.display = 'inline-block';
        document.getElementById('stop-btn').textContent = "‰∏≠Ê≠¢";
        document.getElementById('reset-btn').disabled = true;
        document.getElementById('progress-area').style.display = 'block';
        document.getElementById('log-area').innerHTML = '';

        const config = {
            format: document.getElementById('format').value,
            quality: parseFloat(document.getElementById('quality').value),
            dpi: parseInt(document.getElementById('dpi-number').value) || 120,
            find: document.getElementById('find-txt').value,
            replace: document.getElementById('replace-txt').value
        };

        const zip = useZip ? new JSZip() : null;
        const pdfFiles = fileQueue.filter(f => f.type === 'application/pdf');
        const imgFiles = fileQueue.filter(f => f.type.startsWith('image/'));

        // 1. PDF„Éï„Ç°„Ç§„É´„ÅÆÂá¶ÁêÜ
        for (let i = 0; i < pdfFiles.length; i++) {
            if (abortCtrl) break;
            const file = pdfFiles[i];
            try {
                const { data, fileName } = await processPdf(file, config, useZip);
                await handleSave(data, fileName, useZip, zip, dirHandle);
                addLog(`‚úÖ [PDF] ${fileName}`, 'success');
            } catch (err) {
                if (err.message === 'ABORTED') addLog(`‚õî ${file.name} ‰∏≠Êñ≠`, 'error');
                else addLog(`‚ùå ${file.name} „Ç®„É©„Éº: ${err.message}`, 'error');
            }
        }

        // 2. ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÅÆÂá¶ÁêÜ
        if (imgFiles.length > 0 && !abortCtrl) {
            try {
                const timestampName = getTimestampFilename();
                const { data, fileName } = await processImagesToPdf(imgFiles, config, timestampName, useZip);
                await handleSave(data, fileName, useZip, zip, dirHandle);
                addLog(`‚úÖ [ÁµêÂêà] ${fileName}`, 'success');
            } catch (err) {
                if (err.message === 'ABORTED') addLog(`‚õî ‰∏≠Êñ≠`, 'error');
                else addLog(`‚ùå ÁîªÂÉèÁµêÂêà„Ç®„É©„Éº: ${err.message}`, 'error');
            }
        }

        // ZIP‰øùÂ≠ò
        if (useZip && !abortCtrl && (pdfFiles.length > 0 || imgFiles.length > 0)) {
            addLog(`üì¶ ZIP‰ΩúÊàê‰∏≠...`, 'processing');
            const content = await zip.generateAsync({type:"blob"});
            const zipName = `converted_${getTimestampFilename().replace('.pdf','.zip')}`;

            if (dirHandle) {
                try {
                    const fileHandle = await dirHandle.getFileHandle(zipName, { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(content);
                    await writable.close();
                    addLog(`‚úÖ ZIP‰øùÂ≠òÂÆå‰∫Ü`, 'success');
                } catch(e) {
                    addLog(`‚ùå ‰øùÂ≠ò„Ç®„É©„Éº: ${e.message}`, 'error');
                }
            } else {
                saveAsFile(content, zipName);
                addLog(`‚úÖ ZIP„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ`, 'success');
            }
        }

        finishProcess();
    }

    async function handleSave(data, fileName, useZip, zip, dirHandle) {
        if (useZip) {
            zip.file(fileName, data);
        } else {
            if (dirHandle) {
                const fileHandle = await dirHandle.getFileHandle(fileName, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(data);
                await writable.close();
            } else {
                saveAsFile(data, fileName);
            }
        }
    }

    function finishProcess() {
        isProcessing = false;
        document.getElementById('run-btn').disabled = false;
        document.getElementById('run-btn').textContent = "Â§âÊèõÈñãÂßã";
        document.getElementById('stop-btn').style.display = 'none';
        document.getElementById('reset-btn').disabled = false;
        updateProgress(0, "ÂÆå‰∫Ü");
        setTimeout(() => { if(!isProcessing) document.getElementById('progress-area').style.display = 'none'; }, 3000);
        updateList();
    }

    function updateProgress(percent, text) {
        const bar = document.getElementById('progress-bar');
        bar.style.width = Math.floor(percent) + "%";
        document.getElementById('progress-text').textContent = text;
    }

    // --- ÁîªÂÉè„Éï„Ç°„Ç§„É´Âá¶ÁêÜ (ÁµêÂêà) ---
    async function processImagesToPdf(files, config, outFileName, forZip) {
        const { jsPDF } = window.jspdf;
        let newPdf = null;
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        for (let i = 0; i < files.length; i++) {
            if (abortCtrl) throw new Error('ABORTED');
            updateProgress(((i) / files.length) * 100, `ÁîªÂÉèÂá¶ÁêÜ‰∏≠ (${i + 1}/${files.length})`);
            
            const imgData = await imageFileToDataUrl(files[i], config, canvas, ctx);
            const isLandscape = imgData.width > imgData.height;

            if (newPdf === null) {
                newPdf = new jsPDF({
                    unit: 'pt',
                    format: [imgData.width, imgData.height],
                    orientation: isLandscape ? 'l' : 'p',
                    compress: true
                });
                newPdf.addImage(imgData.data, null, 0, 0, imgData.width, imgData.height);
            } else {
                newPdf.addPage([imgData.width, imgData.height], isLandscape ? 'l' : 'p');
                newPdf.addImage(imgData.data, null, 0, 0, imgData.width, imgData.height);
            }
        }

        updateProgress(100, `‰øùÂ≠ò‰∏≠...`);
        const output = forZip ? newPdf.output('arraybuffer') : newPdf.output('blob');
        return { data: output, fileName: outFileName };
    }

    function imageFileToDataUrl(file, config, canvas, ctx) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => {
                const scale = config.dpi / 72;
                const targetWidth = Math.max(1, Math.floor(img.width * scale));
                const targetHeight = Math.max(1, Math.floor(img.height * scale));

                canvas.width = targetWidth;
                canvas.height = targetHeight;
                ctx.clearRect(0, 0, targetWidth, targetHeight);
                ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
                
                const imgType = config.format === 'jpeg' ? 'image/jpeg' : 'image/png';
                const data = canvas.toDataURL(imgType, config.format === 'jpeg' ? config.quality : undefined);
                resolve({ data: data, width: targetWidth, height: targetHeight });
            };
            img.onerror = reject;
            img.src = URL.createObjectURL(file);
        });
    }

    // --- PDFÂ§âÊèõÂá¶ÁêÜ ---
    async function processPdf(file, config, forZip) {
        const arrayBuffer = await file.arrayBuffer();
        
        const loadingTask = pdfjsLib.getDocument({
            data: arrayBuffer,
            cMapUrl: CMAP_URL,
            cMapPacked: true,
            enableXfa: true
        });
        
        const pdfDoc = await loadingTask.promise;
        const total = pdfDoc.numPages;
        
        const { jsPDF } = window.jspdf;
        let newPdf = null;
        const scale = config.dpi / 72;

        for (let num = 1; num <= total; num++) {
            if (abortCtrl) throw new Error('ABORTED');
            updateProgress(((num - 1) / total) * 100, `${file.name} (${num}/${total})`);
            
            const page = await pdfDoc.getPage(num);
            const viewport = page.getViewport({ scale: scale });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            
            await page.render({ canvasContext: context, viewport }).promise;

            const imgType = config.format === 'jpeg' ? 'image/jpeg' : 'image/png';
            const imgData = canvas.toDataURL(imgType, config.format === 'jpeg' ? config.quality : undefined);
            
            if (newPdf === null) {
                newPdf = new jsPDF({
                    unit: 'pt',
                    format: [viewport.width, viewport.height],
                    orientation: viewport.width > viewport.height ? 'l' : 'p',
                    compress: true
                });
                newPdf.addImage(imgData, null, 0, 0, viewport.width, viewport.height);
            } else {
                newPdf.addPage([viewport.width, viewport.height], viewport.width > viewport.height ? 'l' : 'p');
                newPdf.addImage(imgData, null, 0, 0, viewport.width, viewport.height);
            }
            
            canvas.width = 1; canvas.height = 1;
        }

        updateProgress(100, `‰øùÂ≠òÂá¶ÁêÜ...`);
        let outName = file.name.replace(/\.pdf$/i, '');
        if (config.find) outName = outName.split(config.find).join(config.replace);
        outName += ".pdf";

        const output = forZip ? newPdf.output('arraybuffer') : newPdf.output('blob');
        return { data: output, fileName: outName };
    }

    function saveAsFile(blob, fileName) {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        setTimeout(() => {
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }, 100);
    }

    function addLog(msg, type) {
        const div = document.createElement('div');
        div.className = `log ${type}`;
        div.textContent = msg;
        const log = document.getElementById('log-area');
        log.appendChild(div);
        log.scrollTop = log.scrollHeight;
    }
</script>
</body>
</html>





