<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFå¤‰æ›ï¼†çµåˆãƒ„ãƒ¼ãƒ«</title>
    
    <!-- ==========================================
         ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿
    =========================================== -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>

    <style>
        /* ==========================================
           ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ«
        =========================================== */
        body { font-family: sans-serif; max-width: 800px; margin: 20px auto; background: #f4f4f4; color: #333; }
        .container { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { text-align: center; font-size: 22px; margin-bottom: 25px; }
        .section { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .section:last-child { border: none; }
        .row { display: flex; gap: 20px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 240px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; }
        input[type="text"], select, input[type="number"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* æ•°å€¤å…¥åŠ›ï¼ˆè§£åƒåº¦ç”¨ï¼‰ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        .dpi-input { width: 60px !important; padding: 5px !important; text-align: right; margin-left: 10px; }

        .option-group { margin-top: 5px; }
        .option-label { display: inline-flex; align-items: center; margin-right: 15px; font-weight: normal; cursor: pointer; }
        .option-label input { margin-right: 5px; }
        .range-wrap { display: flex; align-items: center; }
        input[type="range"] { flex: 1; margin: 0; }

        /* ã‚¨ãƒªã‚¢ã‚¹ã‚¿ã‚¤ãƒ« */
        #drop-zone { border: 2px dashed #bbb; padding: 30px; text-align: center; background: #fafafa; border-radius: 6px; cursor: pointer; margin-bottom: 15px; }
        #drop-zone:hover { background: #eef; border-color: #007bff; }
        #file-list-container { background: #fff; border: 1px solid #ddd; border-radius: 4px; max-height: 300px; overflow-y: auto; margin-bottom: 15px; display: none; }
        #file-list { padding: 0; margin: 0; list-style: none; }
        .file-item { display: flex; align-items: center; justify-content: space-between; padding: 5px 10px; border-bottom: 1px solid #eee; font-size: 13px; height: 32px; cursor: grab; }
        .file-item:last-child { border-bottom: none; }
        
        /* å‰Šé™¤ãƒœã‚¿ãƒ³ */
        .remove-btn { background: #ff4d4d; color: white; border: none; border-radius: 2px; width: 20px !important; height: 20px !important; min-width: 0 !important; flex: none !important; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; margin-left: 10px; padding: 0 !important; }
        .remove-btn:hover { background: #cc0000; }
        
        /* æ“ä½œãƒœã‚¿ãƒ³ */
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        button { padding: 12px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; flex: 1; min-width: 120px; }
        #run-btn { background: #007bff; color: white; flex: 2; }
        #run-btn:disabled { background: #ccc; }
        #stop-btn { background: #dc3545; color: white; display: none; flex: 2; }
        #reset-btn { background: #6c757d; color: white; max-width: 150px; }

        /* é€²æ—ãƒ»ãƒ­ã‚° */
        #progress-area { margin-top: 15px; display: none; }
        .progress-track { background: #eee; height: 20px; border-radius: 10px; overflow: hidden; }
        .progress-bar { height: 100%; background: #28a745; width: 0%; transition: width 0.2s; text-align: center; color: white; font-size: 12px; line-height: 20px; }
        #log-area { margin-top: 15px; font-size: 14px; max-height: 200px; overflow-y: auto; background: #f9f9f9; padding: 10px; }
        .log { padding: 4px 0; border-bottom: 1px solid #eee; }
        .success { color: green; } .error { color: red; } .processing { color: #007bff; }
        
        /* ãƒãƒƒã‚¸ */
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; color: white; margin-right: 8px; font-weight: bold; }
        .badge-pdf { background: #d32f2f; }
        .badge-img { background: #1976d2; }
    </style>
</head>
<body>

<div class="container">
    <h1>PDFç”»åƒå¤‰æ›>å†çµåˆ or ç”»åƒPDFçµåˆãƒ„ãƒ¼ãƒ«</h1>

    <!-- è¨­å®š -->
    <div class="section">
        <div class="row">
            <div class="col">
                <label>å¤‰æ›å½¢å¼</label>
                <select id="format" onchange="toggleJpeg()">
                    <option value="png" selected>PNG (æœ€é«˜ç”»è³ª)</option>
                    <option value="jpeg">JPEG (è»½é‡)</option>
                </select>
                <div id="jpeg-box" style="display:none; margin-top:10px;">
                    <label>å“è³ª (0.1 - 1.0)</label>
                    <div class="range-wrap">
                        <input type="range" id="quality" min="0.1" max="1.0" step="0.1" value="0.9" oninput="document.getElementById('q-val').textContent=this.value">
                        <span id="q-val" style="margin-left:10px;">0.9</span>
                    </div>
                </div>
            </div>
            <div class="col">
                <label>è§£åƒåº¦</label>
                <div class="range-wrap">
                    <input type="range" id="dpi-slider" min="72" max="600" step="10" value="350">
                    <!-- æ‰‹å…¥åŠ›ç”¨æ•°å€¤ãƒœãƒƒã‚¯ã‚¹ (è¦‹ãŸç›®ã‚’èª¿æ•´) -->
                    <input type="number" id="dpi-number" value="350" min="1" step="10" class="dpi-input">
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿å­˜è¨­å®š -->
    <div class="section">
        <label>ä¿å­˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³</label>
        <div class="option-group">
            <label class="option-label">
                <input type="checkbox" id="zip-check"> å®Œäº†å¾Œã«ZIPãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã‚‹
            </label>
        </div>
        <div style="margin-top: 10px;">
            <label style="font-size:14px; margin-bottom:5px;">ä¿å­˜å…ˆ:</label>
            <div class="option-group">
                <label class="option-label">
                    <input type="radio" name="save-loc" value="download" checked> ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€ (æ¨™æº–)
                </label>
                <label class="option-label" title="Chrome/Edgeç­‰ã®å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿">
                    <input type="radio" name="save-loc" value="folder"> ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ä¿å­˜
                </label>
            </div>
        </div>
    </div>

    <!-- ç½®æ› -->
    <div class="section">
        <label>PDFãƒ•ã‚¡ã‚¤ãƒ«åç½®æ› (PDFã®ã¿)</label>
        <div class="row">
            <div class="col"><input type="text" id="find-txt" placeholder="æ¤œç´¢æ–‡å­—åˆ—"></div>
            <div class="col"><input type="text" id="replace-txt" placeholder="ç½®æ›æ–‡å­—åˆ—"></div>
        </div>
    </div>

    <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ -->
    <div class="section">
        <div id="drop-zone" onclick="document.getElementById('file-input').click()">
            <p>PDF ã¾ãŸã¯ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ« ã‚’ãƒ‰ãƒ­ãƒƒãƒ—<br>(ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ)</p>
            <input type="file" id="file-input" multiple accept="application/pdf, image/*" style="display:none">
        </div>
        <div id="file-list-container">
            <ul id="file-list"></ul>
        </div>
    </div>

    <!-- ãƒœã‚¿ãƒ³ -->
    <div class="btn-group">
        <button id="run-btn" onclick="start()" disabled>å¤‰æ›é–‹å§‹</button>
        <button id="stop-btn" onclick="cancel()">ä¸­æ­¢</button>
        <button id="reset-btn" onclick="resetAll()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <!-- ãƒ­ã‚° -->
    <div id="progress-area">
        <div id="progress-text" style="font-size:14px; margin-bottom:5px;">æº–å‚™ä¸­...</div>
        <div class="progress-track"><div class="progress-bar" id="progress-bar">0%</div></div>
    </div>
    <div id="log-area"></div>
</div>

<script>
    // --- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªè¨­å®š ---
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    const CMAP_URL = 'https://unpkg.com/pdf.js-dist@3.11.174/cmaps/';
    
    let fileQueue = [];
    let isProcessing = false;
    let abortCtrl = false;
    let sortable; 

    // --- DPIå…¥åŠ›åŒæœŸ ---
    const dpiSlider = document.getElementById('dpi-slider');
    const dpiNumber = document.getElementById('dpi-number');

    dpiSlider.addEventListener('input', function() {
        dpiNumber.value = this.value;
    });
    dpiNumber.addEventListener('input', function() {
        dpiSlider.value = this.value;
    });

    // --- UIæ“ä½œ ---
    function toggleJpeg() {
        document.getElementById('jpeg-box').style.display = document.getElementById('format').value === 'jpeg' ? 'block' : 'none';
    }

    function resetAll() {
        if (isProcessing) return alert("å‡¦ç†ä¸­ã¯ãƒªã‚»ãƒƒãƒˆã§ãã¾ã›ã‚“");
        fileQueue = [];
        document.getElementById('file-input').value = '';
        document.getElementById('log-area').innerHTML = '';
        document.getElementById('progress-area').style.display = 'none';
        document.getElementById('find-txt').value = '';
        document.getElementById('replace-txt').value = '';
        updateList();
    }

    const handleFiles = (files) => {
        if (isProcessing) return;
        Array.from(files).forEach(f => {
            if (f.type === 'application/pdf' || f.type.startsWith('image/')) {
                fileQueue.push(f);
            }
        });
        updateList();
    };

    function updateList() {
        const listEl = document.getElementById('file-list');
        const runBtn = document.getElementById('run-btn');
        listEl.innerHTML = '';
        
        if (fileQueue.length > 0) {
            document.getElementById('file-list-container').style.display = 'block';
            runBtn.disabled = isProcessing;
            runBtn.textContent = `å¤‰æ›é–‹å§‹ (${fileQueue.length} ãƒ•ã‚¡ã‚¤ãƒ«)`;

            fileQueue.forEach((file, index) => {
                const item = document.createElement('li');
                item.className = 'file-item';
                item.dataset.index = index;

                const typeBadge = file.type === 'application/pdf'
                    ? '<span class="badge badge-pdf">PDF</span>'
                    : '<span class="badge badge-img">IMG</span>';

                item.innerHTML = `<span>${typeBadge}${file.name}</span><button class="remove-btn" onclick="removeFile(${index})">âœ•</button>`;
                listEl.appendChild(item);
            });
            
            if (sortable) sortable.destroy();
            sortable = new Sortable(listEl, {
                draggable: '.file-item',
                onUpdate: (evt) => {
                    const movedFile = fileQueue.splice(evt.oldIndex, 1)[0];
                    fileQueue.splice(evt.newIndex, 0, movedFile);
                },
                handle: '.file-item',
                cursor: 'grab',
                animation: 150
            });
        } else {
            document.getElementById('file-list-container').style.display = 'none';
            runBtn.disabled = true;
            runBtn.textContent = 'å¤‰æ›é–‹å§‹';
            if (sortable) { sortable.destroy(); sortable = null; }
        }
    }

    function removeFile(index) {
        if (isProcessing) return;
        fileQueue.splice(index, 1);
        updateList();
    }

    const dropZone = document.getElementById('drop-zone');
    dropZone.ondragover = e => { e.preventDefault(); dropZone.style.background = '#eef'; };
    dropZone.ondragleave = () => dropZone.style.background = '#fafafa';
    dropZone.ondrop = e => { e.preventDefault(); dropZone.style.background = '#fafafa'; handleFiles(e.dataTransfer.files); };
    document.getElementById('file-input').onchange = e => handleFiles(e.target.files);
    document.getElementById('file-input').onclick = e => e.target.value = '';

    function cancel() {
        if (isProcessing) {
            abortCtrl = true;
            document.getElementById('stop-btn').textContent = "åœæ­¢ä¸­...";
        }
    }

    function getTimestampFilename() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        const H = String(now.getHours()).padStart(2, '0');
        const M = String(now.getMinutes()).padStart(2, '0');
        const S = String(now.getSeconds()).padStart(2, '0');
        return `${y}${m}${d}${H}${M}${S}.pdf`;
    }

    // --- ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
    async function start() {
        if (fileQueue.length === 0) return;
        
        const useZip = document.getElementById('zip-check').checked;
        const saveLoc = document.querySelector('input[name="save-loc"]:checked').value;
        let dirHandle = null;

        if (saveLoc === 'folder') {
            if (!('showDirectoryPicker' in window)) {
                alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚æ¨™æº–ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");
            } else {
                try {
                    dirHandle = await window.showDirectoryPicker({ mode: "readwrite" });
                } catch (err) { return; }
            }
        }

        isProcessing = true;
        abortCtrl = false;
        
        document.getElementById('run-btn').disabled = true;
        document.getElementById('run-btn').textContent = "å‡¦ç†ä¸­...";
        document.getElementById('stop-btn').style.display = 'inline-block';
        document.getElementById('stop-btn').textContent = "ä¸­æ­¢";
        document.getElementById('reset-btn').disabled = true;
        document.getElementById('progress-area').style.display = 'block';
        document.getElementById('log-area').innerHTML = '';

        // æ•°å€¤ãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰ç¢ºå®Ÿã«å€¤ã‚’å–å¾—
        const config = {
            format: document.getElementById('format').value,
            quality: parseFloat(document.getElementById('quality').value),
            dpi: parseInt(document.getElementById('dpi-number').value) || 350,
            find: document.getElementById('find-txt').value,
            replace: document.getElementById('replace-txt').value
        };

        const zip = useZip ? new JSZip() : null;
        const pdfFiles = fileQueue.filter(f => f.type === 'application/pdf');
        const imgFiles = fileQueue.filter(f => f.type.startsWith('image/'));

        // 1. PDFãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†
        for (let i = 0; i < pdfFiles.length; i++) {
            if (abortCtrl) break;
            const file = pdfFiles[i];
            try {
                const { data, fileName } = await processPdf(file, config, useZip);
                await handleSave(data, fileName, useZip, zip, dirHandle);
                addLog(`âœ… [PDF] ${fileName} å¤‰æ›å®Œäº†`, 'success');
            } catch (err) {
                if (err.message === 'ABORTED') addLog(`â›” ${file.name} ä¸­æ–­`, 'error');
                else addLog(`âŒ ${file.name} ã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
            }
        }

        // 2. ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ï¼ˆã¾ã¨ã‚ã¦1ã¤ã®PDFï¼‰
        if (imgFiles.length > 0 && !abortCtrl) {
            try {
                addLog(`â„¹ï¸ ç”»åƒ ${imgFiles.length} æšã‚’çµåˆä¸­...`, 'processing');
                const timestampName = getTimestampFilename();
                const { data, fileName } = await processImagesToPdf(imgFiles, config, timestampName, useZip);
                await handleSave(data, fileName, useZip, zip, dirHandle);
                addLog(`âœ… [ç”»åƒçµåˆ] ${fileName} ä½œæˆå®Œäº†`, 'success');
            } catch (err) {
                if (err.message === 'ABORTED') addLog(`â›” ç”»åƒçµåˆå‡¦ç†ã‚’ä¸­æ–­`, 'error');
                else addLog(`âŒ ç”»åƒçµåˆã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
            }
        }

        // ZIPä¿å­˜
        if (useZip && !abortCtrl && (pdfFiles.length > 0 || imgFiles.length > 0)) {
            addLog(`ğŸ“¦ ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆä¸­...`, 'processing');
            const content = await zip.generateAsync({type:"blob"});
            const zipName = `converted_${getTimestampFilename().replace('.pdf','.zip')}`;

            if (dirHandle) {
                try {
                    const fileHandle = await dirHandle.getFileHandle(zipName, { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(content);
                    await writable.close();
                    addLog(`âœ… ZIPã‚’ãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜å®Œäº†`, 'success');
                } catch(e) {
                    addLog(`âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
                }
            } else {
                saveAsFile(content, zipName);
                addLog(`âœ… ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†`, 'success');
            }
        }

        finishProcess();
    }

    async function handleSave(data, fileName, useZip, zip, dirHandle) {
        if (useZip) {
            zip.file(fileName, data);
        } else {
            if (dirHandle) {
                const fileHandle = await dirHandle.getFileHandle(fileName, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(data);
                await writable.close();
            } else {
                saveAsFile(data, fileName);
            }
        }
    }

    function finishProcess() {
        isProcessing = false;
        document.getElementById('run-btn').disabled = false;
        document.getElementById('run-btn').textContent = "å¤‰æ›é–‹å§‹";
        document.getElementById('stop-btn').style.display = 'none';
        document.getElementById('reset-btn').disabled = false;
        updateProgress(0, "å®Œäº†");
        setTimeout(() => { if(!isProcessing) document.getElementById('progress-area').style.display = 'none'; }, 3000);
        updateList();
    }

    function updateProgress(percent, text) {
        const bar = document.getElementById('progress-bar');
        bar.style.width = Math.floor(percent) + "%";
        bar.textContent = Math.floor(percent) + "%";
        document.getElementById('progress-text').textContent = text;
    }

    // --- ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç† (çµåˆ) ---
    async function processImagesToPdf(files, config, outFileName, forZip) {
        const { jsPDF } = window.jspdf;
        // unit: 'pt' ã§åˆæœŸåŒ–
        const newPdf = new jsPDF({ unit: 'pt', compress: true });
        newPdf.deletePage(1);

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        for (let i = 0; i < files.length; i++) {
            if (abortCtrl) throw new Error('ABORTED');
            updateProgress(((i) / files.length) * 100, `ç”»åƒçµåˆä¸­ (${i + 1}/${files.length})`);
            
            // DPIè¨­å®šã‚’åæ˜ ã—ã¦ãƒªã‚µã‚¤ã‚ºã•ã‚ŒãŸç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const imgData = await imageFileToDataUrl(files[i], config, canvas, ctx);
            
            const isLandscape = imgData.width > imgData.height;
            newPdf.addPage([imgData.width, imgData.height], isLandscape ? 'l' : 'p');
            newPdf.addImage(imgData.data, config.format.toUpperCase(), 0, 0, imgData.width, imgData.height);
        }

        updateProgress(100, `çµåˆPDFä¿å­˜ä¸­...`);
        const output = forZip ? newPdf.output('arraybuffer') : newPdf.output('blob');
        return { data: output, fileName: outFileName };
    }

    // DPIã«åŸºã¥ã„ã¦ç”»åƒã‚’ãƒªã‚µã‚¤ã‚ºã—ã¦DataURLåŒ–
    function imageFileToDataUrl(file, config, canvas, ctx) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => {
                // DPIã«åŸºã¥ã„ã¦ã‚¹ã‚±ãƒ¼ãƒ«ã‚’è¨ˆç®— (72dpi = 1.0å€)
                const scale = config.dpi / 72;
                
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’æ•´æ•°å€¤ã§è¨ˆç®— (å°æ•°ç‚¹ã¯ãƒˆãƒ©ãƒ–ãƒ«ã®å…ƒ)
                const targetWidth = Math.floor(img.width * scale);
                const targetHeight = Math.floor(img.height * scale);

                canvas.width = targetWidth;
                canvas.height = targetHeight;
                ctx.clearRect(0, 0, targetWidth, targetHeight);
                
                // ç”»åƒã‚’ãƒªã‚µã‚¤ã‚ºã—ã¦æç”»ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãŒãƒã‚¤ãƒªãƒ‹ã‚¢è£œé–“ç­‰ã‚’è¡Œã†ï¼‰
                ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
                
                const imgType = config.format === 'jpeg' ? 'image/jpeg' : 'image/png';
                const data = canvas.toDataURL(imgType, config.format === 'jpeg' ? config.quality : undefined);
                
                resolve({ data: data, width: targetWidth, height: targetHeight });
            };
            img.onerror = reject;
            img.src = URL.createObjectURL(file);
        });
    }

    // --- PDFå¤‰æ›å‡¦ç† ---
    async function processPdf(file, config, forZip) {
        const arrayBuffer = await file.arrayBuffer();
        
        const loadingTask = pdfjsLib.getDocument({
            data: arrayBuffer,
            cMapUrl: CMAP_URL,
            cMapPacked: true,
            enableXfa: true
        });
        
        const pdfDoc = await loadingTask.promise;
        const total = pdfDoc.numPages;
        
        const { jsPDF } = window.jspdf;
        const newPdf = new jsPDF({ unit: 'pt', compress: true });
        newPdf.deletePage(1);
        const scale = config.dpi / 72;

        for (let num = 1; num <= total; num++) {
            if (abortCtrl) throw new Error('ABORTED');
            updateProgress(((num - 1) / total) * 100, `${file.name} (${num}/${total})`);
            
            const page = await pdfDoc.getPage(num);
            const viewport = page.getViewport({ scale: scale });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            
            await page.render({ canvasContext: context, viewport }).promise;

            const imgType = config.format === 'jpeg' ? 'image/jpeg' : 'image/png';
            const imgData = canvas.toDataURL(imgType, config.format === 'jpeg' ? config.quality : undefined);
            
            newPdf.addPage([viewport.width, viewport.height], viewport.width > viewport.height ? 'l' : 'p');
            newPdf.addImage(imgData, config.format.toUpperCase(), 0, 0, viewport.width, viewport.height);
            
            canvas.width = 1; 
            canvas.height = 1;
        }

        updateProgress(100, `${file.name} ä¿å­˜å‡¦ç†...`);
        
        let outName = file.name.replace(/\.pdf$/i, '');
        if (config.find) outName = outName.split(config.find).join(config.replace);
        outName += ".pdf";

        const output = forZip ? newPdf.output('arraybuffer') : newPdf.output('blob');
        return { data: output, fileName: outName };
    }

    function saveAsFile(blob, fileName) {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        setTimeout(() => {
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }, 100);
    }

    function addLog(msg, type) {
        const div = document.createElement('div');
        div.className = `log ${type}`;
        div.textContent = msg;
        const log = document.getElementById('log-area');
        log.appendChild(div);
        log.scrollTop = log.scrollHeight;
    }
</script>
</body>
</html>
